\chapter{ Архитектура web-приложений } \label{chapt2}

%24

Перед началом активной разработки необходимо продумать основные идеи архитектуры приложения. В этой главе будут рассмотрены некоторые принципы проектирования web-приложений в условиях реального мира, особенности аппаратной составляющей и её влияние на проект.

\section{ Приложение, как слоёный пирог} \label{sect2_1}

Хорошее приложение должно иметь несколько слоёв абстракций.

Низший, основной слой, --- постоянное хранилище. Данные в хранилище лежат в основе приложения. 

%26

Следующий слой это бизнес логика. Именно бизнес логика определяет как  и какие данные будут записаны и прочитаны из хранилища. Основной язык для написания бизнес логики --- PHP, или другой скриптовый язык.

Следующий уровень абстракций --- логика взаимодействий. Именно она отвечает за то, какие данные будут использованы вместе и где. Это логика не зависит от бизнес логики и тем более от логики хранилища.

Верхний уровень абстракций --- это пользовательский интерфейс, который, обычно, представлен языком разметки. Именно этот слой отображает данные пользователю в приятном для него виде.

%27
Но как истинный кулинар не оставит своё блюдо без украшения, так и нельзя оставить пользовательский интерфейс без украшений, который в web-приложениях представлены в виде CSS.

Каждый слой имеет своё предназначение и предоставляет определённый функционал. Слои должны идти в правильном порядке для полноценного взаимодействия и не перемешиваться, хоть в реальных проектах зачастую и происходит смешивание этих слоёв.

\section{ Технологии расслоения } \label{sect2_2}

Верхним слоем абстракций являются каскадные таблицы стилей. В примерах будут встречаться встроенные стили, но всё же будем стараться разделять язык разметки от стилей.

Под уровнем представления лежит уровень отображения, который основан на языке разметки. Основным языком разметки является HTML и его семейство. Непроходимо разделять логику и представление(отображение) --- для этого необходимо отдельно выносить шаблоны, которые будут заполняться логикой на основе данных из хранилища. 

%28

При разделении логики и представления, вносимые изменения в один слоёв не будут влиять на другой. Таким образом, например, изменив представления с табличного на текстовое, логика никак не измениться.

Разделение логики и представления --- один из ключевых принципов проектирование программного обеспечения.

Для различных языков программирования существуют различные шаблонизаторы, которые помогают разделить логику и представление. Например, для PHP существует Smarty, предоставляющий простой и понятный синтаксис и разделяющий данные во внешнем приложении и внутри шаблона.

Следующий два слоя абстракций - бизнес логика и логика взаимодействия. Один из них определяет как пользователь будет работать с данными, другой - как приложение будет работать с данными. Способы реализации разделения на эти слои может варьироваться от языка программирования и архитектурных решений.

По соглашению, в PHP файлы логики взаимодействия хранятся в корневой директории, куда смотрит web-сервер и имеют расширения .php, а файлы бизнес логики лежат в другом каталоге и имею расширения .inc.

В Perl для разделения логики используются различные пространства имён: для бизнес логики MyApp::Core::*, а для логики взаимодействия MyApp::WWW::*.

%29

При создании гетерогенных слоёв, вся логика разделения на слои ложиться на инженера, который должен обеспечит взаимодействие между этими слоями.

Низший слой абстракций --- хранилище, которое отлично отделено от проекта и бизнес логики. Несмотря на то, что можно использовать бизнес логику внутри хранимых процедур в системах управления базами данных, в этой книге это рассматриваться не будет.

Не так важно, каким хранилищем пользоваться, ведь они все выполняют определённую работу. В книге будут рассматриваться MySQL как база данных и POSIX подобные файловые системы.

\section{ Проектирование интерфейсов приложения } \label{sect2_3}

Разделение приложения на слои означает необходимость проектирования взаимодействия между слоями. Но необходимо понимать, что бизнес логика и логика взаимодействия плотно переплетены и не требуют дополнительных изменений, в отличии от слоя представления.

Разделение на уровни абстракций помогают улучшить работу над проектом, ведь разные уровни будут находиться физически в разных файлов, что потребует меньшего взаимодействия между разработчиками, так же разработчику можно будет сосредоточиться на выполнении своей задачи в своём уровне и не задумываться о других уровнях. Разработчику внутри своего уровня нужно будет знать о соседних уровнях лишь интерфейс взаимодействия.

Говоря об интерфейсах между слоями необходимо понимать, что это не Java-подобные интерфейсы. В данном случае под интерфейсом понимается соглашение об обмене данными и сообщениями между слоями.

В контексте данной книге не будут рассматриваться методы проектирования пользовательских интерфейсов. Посему в разметке будут лишь встречаться теги загрузки файлов стилей и никакие стилей не будет описываться внутри тэгов. Таким образом будет отделена разметка от стилей.

Логика взаимодействия общается с разметкой посредством шаблонизатора. В  нашем случае это связь между PHP и Smarty.Мы можем вызывать методы Smarty для передачи данных внутрь шаблона и на выходе получать готовую разметку. Так например, мы можем создать шаблон электронной почты, передать туда данные, получить готовую разметку, записав её в переменную. После чего отправить данные в отправитель электронной почты.

Взаимодействия между двумя слоями логики может быть образовано посредством вызова функций, если проект написан на одном языке программирования. Разделение слоёв может быть реализовано посредством библиотек, пространства имен, схем данных. 

Наличие перехода от одной большой функции к объектно-ориентированному программированию --- современный подход в разработке приложений. Например, один из самых распространённых ООП подходов в web-приложениях является подход модель-представление-контроллер.

В движении от одной большой функции в ООП меняются подходы к программированию, отладке и разворачиванию приложений. Двигаясь в различных направлениях можно потерять плюсы и минусы каждого подхода.

При общении приложения с хранилищем, приложения не важно, как устроено хранилище и как физически хранятся данные. Приложение лишь имеет интерфейс работы с хранилищем с помощью которого оно может получать и сохранять данные.

%32

Проектирование интерфейсов --- центральная часть в проектировании web-приложений. Интерфейсы могут меняться со временем для улучшения производительности и увеличения возможностей. 

\section{ Отправления из пункта A в пункт B } \label{sect2_4}

При проектировании приложения, надо понимать уровень его масштабируемости. Нету смысла создавать для небольшого приложения огромные фундамент масштабируемости. Иногда есть смысл создать прототип приложения, для того чтобы запустить приложение как можно скорее, а потом внедрять в него фундамент масштабируемости и новые возможности.

Для начала разработки необходимо разделить уровень представления, выделить отдельные шаблоны. Этот процесс можно разделить на три этапа:
\begin{itemize}

\item \textbf{Отделить логику от разметки.} Первый шаг требует просто выделить весь код, генерирующий HTML в отдельные файлы.

\item \textbf{Выделить разметку для каждой станицы.} Сделать так, что бы блоки разметки можно использовать в разных страницах.

\item \textbf{Переключиться на использование шаблонизатора.}Шаг за шагом надо пройти по всем файлам с разметкой и изменить их под требования шаблонизатора.

\end{itemize}

Теперь, когда у нас есть выделенные шаблоны, имеет смысл выделить все стили в отдельные CSS файлы.

%33

После того, как разметка и представление отделены от кода, необходимо разделить бизнес логику и логику взаимодействия.

Один из подходов формирования модулей бизнес логики --- выделение всех функций, использующих одну таблицу, в отдельный файл. Такой подход позволяет сосредоточить определенный функционал в одном месте, что в дальнейшем упростит логику редактирования.

Процесс отделения бизнес логики от логики взаимодействия может проходить поэтапно, шаг за шагом выделяя новый модуль. Таким образом в итоге получится выделенная бизнес логика.


\section{ Разделения программного и аппаратного обеспечения } \label{sect2_5}

Инженер программного обеспечения, исходя из своего наименования, должен разрабатывать программное обеспечение. Но для современных web-приложений роль аппаратного обеспечения немаловажна.

Никогда не стоит забывать про аппаратное обеспечение. С самого начала разработки приложения необходимо быть в тесном контакте с теми, кто будет отвечать за аппаратуру. Конечно, разработчик не должен вдаваться во все подробности технической составляющей, но некоторые вопросы он должен понимать.

%34

\section{ Аппаратная платформа } \label{sect2_6}

Проектирования аппаратной платформ обязательно для больших масштабируемых приложений. Но важно понимать, что денежные вложения на аппаратуру будут в самом начале разработки. 

\begin{center}
\begin{minipage}
{0.8\textwidth} 
\textbf{Что же такое аппаратная платформа?}\\
Когда мы говорим об аппаратной платформы, мы не имеем ввиду конкретные процессоры или архитектуры, мы говорим об комплексе серверов, сетей,  программного обеспечения. Аппаратная платформа может быть представлена как и одним компьютером с одной операционной системой, так и группой серверов в различным программным обспечениям.
\end{minipage}
\end{center}

Процитируем Дональда Кнута : 
\begin{flushleft}
\begin{verse}
Мы должны забыть об эффективности в 97 процентов случаев. Преждевременная оптимизация --- корень зла.
\end{verse}
\end{flushleft}

Эта цитата применяется обычно к разработке программного обеспечения, но применима и к аппаратной платформе. Не стоит слишком много времени тратить на неё в самом начале разработки.

\textbf{Покупка оборудования}

При покупке оборудования важно правильно подобрать необходимые компоненты: не купит слишком слабое и не потратить слишком много денег на ненужные мощности. Возможно стоит взять среднее оборудование и запустить приложение на нём.

%35

\textbf{Используйте подготовленные операционные системы}

Не стоит тратить время и деньги на точную настройку операционной системы. Базовые настройки позволяют запустить любое приложение с достаточной производительностью.

\textbf{Используйте подготовленное программное обеспечение}

Использование подготовленных бинарников позволит избежать проблем с появлением недокументированных ошибок при использования самособранного программного обеспечения.



\section{ Использование хостинга } \label{sect2_7}

При начальном размещение имеет смысл использовать совместный хостинг, когда на одном сервере находиться множество проектов. Это достаточно дешево и не требует затрат на настройку аппаратной и программной части.

%36

\section{ Использование выделенного хостинга } \label{sect2_8}

Выделенный хостинг подразумевает, что вы получаете сервер в собственной пользование, но при это все проблемы с оборудованием, сетями, электропитанием и прочим на себя берёт хостинг площадка. Вы лишь получаете полный доступ к серверу по системе удалённого доступа. Таким образом вы получаете достаточные мощности за небольшие деньги. Для большинства проектов такой уровень размещения подходит лучше всего.

\section{ Совместное размещение } \label{sect2_9}

Когда вы перерастёте использование арендованного оборудования, вам придется покупать своё оборудование и размещать его в дата-центрах. При таком размещение вам придется самим договариваться с провайдерами интернета, обслуживать оборудование. Сотрудники дата-центра лишь помогут визуально осмотрев оборудование или перезагрузив его. Вся ответственность ложиться на вас.

%37 

\section{ Собственный дата-центр } \label{sect2_10}

Когда количество серверов перерастает сотню необходимо задумываться о постройки собственного дата-центра. Создание собственного дата-центр это большая ответственность, ведь придется нанимать различных специалистов поддержки, покупать станции бесперебойного питания, и множество различного оборудования.

Некоторые размещают собственное оборудование внутри офиса, но это плохой шаг, ведь в случае отключения интернета или света в офисе , вы останетесь вне сети, выведенный из работы. Кроме того у многих провайдеров исходящий канал стоит намного дороже, чем входящий.

\section{ Развития аппаратной платформы } \label{sect2_11}

Приложение,которое выдерживает 100000 пользователей на выделенном сервере, потребует 100 серверов для выдерживания нагрузки в 10 миллионов пользователей. Поддержание платформы на 100 серверах потребует дополнительных внедрений.

Наличие специального человека, кто будет заниматься аппаратной платформой для небольших проектов не имеет смысла.

%38

\section{ Доступность и жизненный цикл } \label{sect2_12}

При выборе производителей аппаратной платформы необходимо подумать о том, как быстро поставщик сможет поставить такое же оборудование и как долго это оборудование будет производиться. Так же перед выбором производителя  было бы неплохо связаться с ним и узнать как долго он собирается поддерживать то оборудование, что вы хотите купить. И можно почитать отзывы на данного производителя.

\section{ Доставка, импорт и установка } \label{sect2_13}

Если вы находитесь вне США, вам не избежать проблем с доставкой и импортом оборудования, что может занять много времени и привести к дополнительным тратам. Вам необходимо заложить в проект все возможные дополнительные траты денег и времени.

Покупая у местных торговых посредников, держите в голове, что посредник мог ещё не доставить и не растаможить товар, что неминуемо займет время.

Если вы размещаете свои сервера в чужом дата-центре, хорошей практикой будет сначала доставить оборудование в офис, настроить его, и, только после этого, устанавливать его в ДЦ.

\section{ Свободное место } \label{sect2_14}

Перед размещением оборудования необходимо узнать, сколько свободных стоек есть ДЦ, смогут ли стойки вместить всё ваше оборудование, какова связность стоек, какие провайдеры подведены к каким стойкам.

Переезд из одного ДЦ в другой может сопровождаться множеством проблем. Так вам придется позаботиться о дополнительном оборудование, пока текущее будет выведено из строя из-за переезда.

\section{ Электроснабжение } \label{sect2_15}

Каждое оборудование потребляет электроэнергию. Вам необходимо позаботиться о бесперебойном питании каждого сервера: рассчитать количество сервером и потребляемую мощность. Сколько бы серверов вы не купили, если в ДЦ отключиться электроснабжение, они все уйдут в оффлайн.

\section{ Комплексный подход к управлению сетями } \label{sect2_16}

Центр управления сетями отслеживает все события в сетях провайдеров: будь-то сетевая атака или проблемы с доступностью. Обычно ЦУС не предоставляет услуги  перезагрузки серверов, замены умерших винчестеров. Но за дополнительную плату они могут предоставлять и подобные услуги.

%40

\section{ Связность } \label{sect2_17}

Обычно, ДЦ предоставляет канал для доступа в интернет в 100 МБит/секунду, но за дополнительную плату канал может быть расширен до 1 Гигабита и более. Так же неплохо иметь резервный канал на случай падения основного. Наличие специального канала для управления сервера, в обход основного и резервного, поможет в случае различных атак и прочих проблем с доступностью.

\section{ Аппаратная избыточность } \label{sect2_18}

Планирование непрерывности бизнеса ( BCP ) требует планирования избыточности. BCP это методология управления рисками. В случае web-приложения эти риски представлены отказом программной или аппаратной части, атаками или катастрофами. BCP обычно означает наличие плана восстановления работоспособности после катастрофы.

BCP так же подводит нас к принципу разделяй и властвуй. На низком уровне это означает использования зеркалирования данных на уровне рейд-массивов. На высшем уровне это означает зеркалирование приложения в различных ДЦ на разных континентах.

Абсолютно всё ломается и абсолютно всё сломается, посему в лучшем случае необходимо иметь точные копии всего: будь-то жесткие диски или кабели питания.

%41

\section{ Сети } \label{sect2_19}

Семи уровневая модель OSI была впоследствии заменена на более простую для понимая четырёх уровневую модель  TCP/IP.

Нижний уровень модели ( канальный ) объясняет физическую модель взаимодействия на уровне сигналов ( радио волны, например), и способ раскодирования данных.

На следующем уровне ( сетевой ), сообщения доставляются между сетями посредством IP пакетов.

На транспортном уровня происходит отправка сообщений. Транспортный уровень либо гарантирует доставку пакетов ( TCP ) либо нет ( UDP ).

На верхнем уровне ( прикладной ) происходит магия доставки данных. 

Каждый уровень основывается на ниже лежащем. Так, посылка сообщений от одного компьютера другому из одной сети будет выглядеть так: HTTP -> TCP -> IP -> Ethernet -> Ethernet -> IP -> TCP -> HTTP. При этом сообщений пройдут по всем уровне с верхнего к нижнему ( прикладной, транспортный, сетевой, канальный ) и обратно.

%42

Различное оборудование работает на разных уровнях Так балансеры нагрузки работают на нижних уровнях модели OSI, маршрутизаторы работаю на 1и 2 уровнях. А сервера и клиента работают через все уровни. Пакет данных проходя через интернет, постоянно проходит по всем слоям модели OSI. Для лучшего понимания сетевых технологий необходимо изучать дополнительную литературу.

%43

Главное, что вас будет интересовать в сетевой статистике --- это сколько данных вы можете отправить через ваши сети. Эти данные зависят от множества факторов, будь-то возможности вашего оборудования, качество кабелей, скорость соединения с провайдером. 

Всё это не так важно, если вы не собираетесь нагружать интернет более чем на 1 Гигабит.

\section{ Языки программирования, Технологии и СУБД } \label{sect2_20}

Дочитав до этого момента вы должна прекрасно понимать с какими технологиями вы будете иметь дело. Важно, что все уроки и примеры могут быть применены к любой модели разработки.

Хорошей практикой является использование тех технологий, что всеми используется вместе, ведь они испытаны в связке. Так, например, стек LAMP технологий (Linux, Apache, MySQL, PHP ) зарекомендовал себя во многих проектах. 

Основные примеры в книге представлены на PHP. Когда мы говорим о веб-сервере, мы имеем ввиду Apache, который требует соответствующую операционную систему (Linux). В качестве СУБД будет использоваться MySQL. 




































\clearpage


